<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-touch-icon" href="icon.png">
    <title>Trip Compass</title>
    <link rel="icon" type="image/png" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    /* --- å…¨åŸŸè¨­å®š --- */
    html {
        scroll-snap-type: y mandatory;
        scroll-padding-top: 180px;
        scroll-behavior: smooth;
    }
    body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; margin: 0; padding: 0; color: #5F6368; overflow-x: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* --- å®¹å™¨èˆ‡ä½ˆå±€ --- */
    #app-container {
        max-width: 500px;
        margin: 0 auto;
        min-height: 100vh;
        background-color: white;
        padding-top: 0px; 
        padding-bottom: 140px;
        position: relative;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    #schedule-list-container {
        padding-top: 180px; 
        padding-bottom: 85vh; 
        margin-top: 0; 
        position: relative; 
        z-index: 1; 
    }
    #schedule-list-container::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 600px; 
        background-color: white;
        z-index: -2; 
    }    
    
    /* --- è¡Œç¨‹å¡ç‰‡ --- */
    .trip-card { 
        width: 100%; 
        margin-bottom: 2rem; 
        position: relative; 
        height: 100px; 
        display: flex; 
        z-index: 0;
        scroll-snap-align: start;
        scroll-snap-stop: always;
        scroll-margin-top: 180px;
    }

    #schedule-list-container .trip-card:first-child {
        margin-top: 10px; 
    }

    .trip-card::before {
        content: '';
        position: absolute;
        left: 28px; 
        top: -6px; 
        bottom: -6px; 
        width: 2px;
        background-color: #9C8B74; 
        z-index: -1; 
        transform: translateX(-50%);
    }
    
    .trip-card:first-child::before { top: -60px; bottom: -6px; height: auto; }
    .trip-card:last-child::before { bottom: auto; height: 100%; }

    .trip-card-visual-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 0.75rem; 
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1); 
        background-color: white; 
        z-index: 10; 
    }

    /* --- Header --- */
    header { 
        position: fixed;
        top: 0; 
        left: 0;
        right: 0;
        width: 100%; 
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
        background-color: #ffffff;
        z-index: 50; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    #header-content-wrapper {
        padding-top: calc(15px + env(safe-area-inset-top)); 
        padding-bottom: 4px; 
        padding-left: 12px; 
        padding-right: 12px;
    }
    #trip-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%237E92A1' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right center; background-repeat: no-repeat; background-size: 1.25em 1.25em; -webkit-appearance: none; appearance: none; background-color: transparent; font-weight: 800; color: #4A4B4D; border: none; padding-right: 1.5rem; cursor: pointer; }
    #trip-select:focus { outline: none; }

    /* --- Footer --- */
    #combined-bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 480px; background-color: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); z-index: 50; display: flex; flex-direction: column; padding: 0.4rem 0.75rem 0.2rem 0.75rem; border-radius: 24px; border: 1px solid #f0f0f0; }
    .prominent-integrated-btn { width: 30px; height: 30px; background-color: #7E92A1; border-radius: 50%; color: white; font-size: 18px; font-weight: 300; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: transform 0.1s; }
    .prominent-integrated-btn:active { transform: scale(0.95); }
    #rate-display-label { font-size: 0.85rem; font-weight: bold; color: #7E92A1; line-height: 20px; }
    #bar-calc-result { font-size: 0.7rem; font-weight: bold; color: #7E92A1; }

    /* --- Swipe Actions --- */
    .swipe-item-container { position: relative; overflow: hidden; border-radius: 0.375rem; margin-bottom: 0.5rem; touch-action: pan-y; }
    .swipe-item-delete-bg { 
        position: absolute; top: 0; bottom: 0; right: 0; width: 140px; 
        display: flex; align-items: center; justify-content: flex-end; 
        z-index: 0; 
        border-radius: 0.75rem;
        overflow: hidden;
    }
    .swipe-item-content { 
        position: relative; z-index: 10; background-color: white; 
        transition: transform 0.2s ease-out; transform: translateX(0); 
        width: 100%; display: flex; align-items: stretch; 
        border-radius: 0.75rem;
        overflow: hidden;
    }

    .card-right-col { 
        display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; gap: 8px; 
        width: 95px; min-width: 95px; flex: 0 0 95px;
        padding-left: 6px; padding-top: 12px; position: relative; 
    }
    .card-right-col::before { content: ''; position: absolute; left: 0; top: 8%; bottom: 8%; width: 1px; background-color: #C0C0C0; }

    .card-static-actions { display: none !important; width: 100%; justify-content: flex-start !important; gap: 2px; }

    @media (min-width: 501px) {
        .swipe-item-delete-bg { display: none !important; }
        .card-static-actions { display: flex !important; }
        .desktop-del-btn { display: block !important; }
    }
    @media (max-width: 500px) {
        .desktop-del-btn { display: none !important; }
        #bar-calc-amount { width: 50px !important; }
        #bar-calc-currency { width: 45px !important; }
    }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(95, 99, 104, 0.4); display: flex; justify-content: center; align-items: center; z-index: 100; }
    .compact-input { padding: 0 0.3rem; font-size: 0.7rem; height: 28px; line-height: 28px; color: #5F6368; border-color: #E0E0E0; border-width: 1px; box-sizing: border-box; }
    .compact-label { font-size: 0.7rem; color: #7E92A1; font-weight: 700; }
    .shopping-img-box { width: 50px; height: 50px; background-color: #f0f0f0; border-radius: 6px; overflow: hidden; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px dashed #ccc; position: relative; }
    </style>
</head>

<body>
    <div id="app-container">
        <header>
            <div id="header-content-wrapper">
                <div class="flex justify-between items-start">
                    <div class="flex flex-col flex-grow min-w-0 mr-2">
                        <div class="flex items-center w-full mb-0.5">
                              <button id="settings-btn" class="p-1 mr-0.5 text-[#888888]">ğŸ“…</button>
                              <select id="trip-select" class="w-full text-lg truncate font-extrabold"></select>
                        </div>
                        <div class="flex items-center space-x-1 text-[#888888] ml-1 mb-1.5">
                              <span class="font-bold text-xs">ğŸ‘«</span>
                              <span id="header-members-list" class="truncate text-xs font-bold text-gray-400">...</span>
                        </div>
                        <div id="day-tabs-container" class="flex overflow-x-auto space-x-2 pb-1 no-scrollbar mb-0.5"></div>
                        <div id="header-day-date-container">
                            <h2 id="header-day-date-display" class="text-sm font-bold text-[#4A4B4D]"></h2>
                        </div>
                    </div>
                    <div id="weather-info-container" class="flex flex-col items-end text-[#888888] flex-shrink-0 gap-2 pt-1">
                          <div id="header-weather-icon" class="text-4xl leading-none"></div>
                          <span id="header-weather-temp" class="text-sm font-bold"></span>
                          <span id="header-location-name" class="text-xs font-bold"></span>
                          <span id="header-clothing-advice" class="text-xs font-bold text-[#CB8572] whitespace-nowrap"></span>
                    </div>
                </div>
            </div>
        </header>
        <div id="schedule-list-container" class="px-3 pt-0 pb-4">
            <div class="p-4 text-center text-[#A9A9A9] text-xs">è¡Œç¨‹åŠ è¼‰ä¸­...</div>
        </div>
    </div>

    <div id="combined-bottom-bar">
        <div id="currency-display-row" class="flex w-full border-b border-gray-100 pb-2 mb-1 mt-1.5">
            <div id="rate-display-container" class="flex items-center justify-center" style="width: 50%; border-right: 1px solid #f3f4f6;">
                <span id="rate-display-label">åŒ¯ç‡ â‰ˆ ...</span> 
            </div>
            <div class="flex items-center justify-start gap-0.5 pl-3" style="width: 50%;">
                <select id="bar-calc-currency" class="bg-gray-50 border border-[#E0E0E0] rounded p-0.5 text-[10px] font-bold text-[#5F6368] h-6 w-10 text-center appearance-none">
                    <option value="USD">USD</option><option value="JPY">JPY</option><option value="KRW">KRW</option><option value="CNY">CNY</option><option value="GBP">GBP</option>
                </select>
                <input type="number" id="bar-calc-amount" class="w-20 h-6 text-[10px] p-0.5 border border-[#E0E0E0] rounded text-center font-medium">
                <span class="text-[1.1rem] font-bold text-[#A9A9A9]">=</span>
                <span class="text-[0.7rem] font-bold text-[#7E92A1] leading-[26px]">TW</span>
                <input type="text" id="bar-calc-result" readonly class="w-12 h-6 p-0 border-none bg-transparent text-[#7E92A1] font-extrabold text-left truncate pl-1">
            </div>
        </div>
        <div class="flex justify-between items-center w-full px-2 py-1.5">
             <button id="btn-lists" class="flex-1 flex flex-row items-center justify-center gap-2 text-[#888888]"><span class="text-xl">ğŸ“</span><span class="text-[12px] font-bold">æ¸…å–®</span></button>
             <div class="flex-none px-4"><button id="center-add-btn" class="prominent-integrated-btn shadow-md">ï¼‹</button></div>
             <button id="split-expense-btn" class="flex-1 flex flex-row items-center justify-center gap-2 text-[#888888]"><span class="text-xl">ğŸ’°</span><span class="text-[12px] font-bold">èŠ±è²»</span></button>
        </div>
    </div>

    <div id="add-schedule-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-3 w-11/12 max-w-sm max-h-[90vh] overflow-y-auto relative"></div></div>
    <div id="lists-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm max-h-[80vh] flex flex-col relative"><h3 class="text-base font-bold mb-2 flex justify-between items-center flex-shrink-0 text-[#4A4B4D]">æ¸…å–®<button id="lists-modal-close-btn" class="text-[#A9A9A9] text-xl leading-none">Ã—</button></h3><div id="list-tabs" class="flex items-center gap-1 border-b border-gray-100 mb-2 overflow-x-auto no-scrollbar flex-shrink-0"></div><div id="list-content" class="flex-grow overflow-y-auto flex flex-col relative"></div></div></div>
    <div id="split-expense-modal" class="modal-overlay hidden"></div>
    <div id="image-zoom-modal" class="modal-overlay hidden z-[150] bg-black/80"><img id="zoom-img" class="max-w-[95%] max-h-[90%] rounded shadow-lg object-contain"></div>
    <div id="settings-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm"></div></div>
    <div id="new-trip-modal" class="modal-overlay hidden"><div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm"></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.App = (function() {
            const appId = 'my-trip-app';
            const firebaseConfig = {
                apiKey: "AIzaSyDx2yrJ3YUe93A-JdgJPtZChLvylCEht28",
                authDomain: "mytravelplanner-36283.firebaseapp.com",
                projectId: "mytravelplanner-36283",
                storageBucket: "mytravelplanner-36283.firebasestorage.app",
                messagingSenderId: "86504733738",
                appId: "1:86504733738:web:5167a6a795eb206dfed753"
            };
            
            const COUNTRY_CONFIG = { 
                'USA': { name: 'ç¾åœ‹', currency: 'USD', localName: 'New York', lat: 40.71, lon: -74.00 }, 
                'JP': { name: 'æ—¥æœ¬', currency: 'JPY', localName: 'æ±äº¬', lat: 35.68, lon: 139.76 }, 
                'KR': { name: 'éŸ“åœ‹', currency: 'KRW', localName: 'ì„œìš¸', lat: 37.56, lon: 126.97 }, 
                'UK': { name: 'è‹±åœ‹', currency: 'GBP', localName: 'London', lat: 51.50, lon: -0.12 }, 
                'TW': { name: 'å°ç£', currency: 'TW', localName: 'å°åŒ—', lat: 25.03, lon: 121.56 } 
            };
            
            const CATEGORY_COLORS = { 'coffee': { bg: 'bg-[#9C8B74]', hex: '#9C8B74', text: 'text-[#9C8B74]' }, 'restaurant': { bg: 'bg-[#CB8572]', hex: '#CB8572', text: 'text-[#CB8572]' }, 'location': { bg: 'bg-[#8F9E8B]', hex: '#8F9E8B', text: 'text-[#8F9E8B]' }, 'äº¤é€š': { bg: 'bg-[#7E92A1]', hex: '#7E92A1', text: 'text-[#7E92A1]' }, 'shopping': { bg: 'bg-[#9E869C]', hex: '#9E869C', text: 'text-[#9E869C]' }, 'accommodation': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' }, 'default': { bg: 'bg-[#A9A9A9]', hex: '#A9A9A9', text: 'text-[#A9A9A9]' } };
            const MEMBER_COLORS = ['text-[#CB8572]', 'text-[#7E92A1]', 'text-[#8F9E8B]', 'text-[#9E869C]', 'text-[#9C8B74]'];
            const CATEGORY_NAMES = { 'location': 'æ™¯é»', 'restaurant': 'é¤å»³', 'coffee': 'å’–å•¡å»³', 'äº¤é€š': 'äº¤é€š', 'shopping': 'è³¼ç‰©', 'accommodation': 'ä½å®¿', 'default': 'æœªåˆ†é¡' };

            let db, auth, currentUser;
            let currentTripId = '', currentDayId = 'Day 1', editingScheduleId = null, tripData = {};
            let unsubscribeSchedule = null, unsubscribeTrips = null, unsubscribeLists = null, expenseChart = null, currentTripRate = 1;
            let currentListTabId = null; 

            // --- åŸºç¤å·¥å…· ---
            function formatDateForHeader(date) { const year = String(date.getFullYear()).slice(-2); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); const dayOfWeekMap = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; return `${year}.${month}.${day} ${dayOfWeekMap[date.getDay()]}`; }
            function dateDiffInDays(date2, date1) { return Math.ceil(Math.abs(date2.getTime() - date1.getTime()) / (1000 * 60 * 60 * 24)); }
            function getDateFromDayId(trip, dayId) { if (!trip || !trip.startDate) return null; const d = new Date(trip.startDate); d.setDate(d.getDate() + (parseInt(dayId.replace('Day ', '')) - 1)); return d; }
            function getCardStyle(type) { const c = CATEGORY_COLORS[type] || CATEGORY_COLORS['default']; const icons = {'coffee':'â˜•','restaurant':'ğŸ½ï¸','location':'ğŸ“','äº¤é€š':'ğŸš—','shopping':'ğŸ›ï¸','accommodation':'ğŸ›ï¸'}; return { color: c.bg, icon: icons[type] || 'â“', hex: c.hex, text: c.text }; }
            function formatCurrency(value) { if (typeof value !== 'number') value = parseFloat(value); if (isNaN(value) || value === 0) return '0'; return value.toFixed(2).replace(/\.00$/, '').replace(/(\.\d)0$/, '$1'); }
            async function fetchExchangeRate(baseCurrency) { const fallback = { 'USD': 32.5, 'JPY': 0.215, 'KRW': 0.023, 'GBP': 41.2, 'CNY': 4.5, 'TW': 1 }; if (!baseCurrency || baseCurrency === 'TW') return 1; try { const r = await fetch(`https://open.er-api.com/v6/latest/${baseCurrency === 'TW' ? 'TWD' : baseCurrency}`); const d = await r.json(); if (d && d.rates && d.rates.TWD) return d.rates.TWD; } catch (e) {} return fallback[baseCurrency] || 1; }

            // --- æ›´æ–° Header ---
            function updateHeaderDateWithDDay(d) {
                if (!d) return;
                const dateStr = formatDateForHeader(d);
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const trip = tripData[currentTripId];
                let tripCountdownHtml = '';
                if (trip && trip.startDate) {
                    const tripStart = new Date(trip.startDate); tripStart.setHours(0, 0, 0, 0);
                    const diffTimeTrip = today.getTime() - tripStart.getTime();
                    const diffDaysTrip = Math.floor(diffTimeTrip / (1000 * 60 * 60 * 24));
                    let dString = diffDaysTrip === 0 ? 'D-0' : (diffDaysTrip > 0 ? `D+${diffDaysTrip + 1}` : `D${diffDaysTrip}`);
                    tripCountdownHtml = `<span class="ml-2 text-[#7E92A1] text-xs font-bold tracking-wide">ğŸ›« ${dString}</span>`;
                }
                const anniversary = new Date('2025-08-01T00:00:00');
                const diffTimeLove = today.getTime() - anniversary.getTime();
                const diffDaysLove = Math.floor(diffTimeLove / (1000 * 60 * 60 * 24)) + 1;
                let loveHtml = !isNaN(diffDaysLove) ? `<span class="ml-2 text-[#D4A5A5] text-xs font-extrabold tracking-wide">â¤ï¸ ${diffDaysLove}å¤©</span>` : '';
                document.getElementById('header-day-date-display').innerHTML = `${dateStr}${tripCountdownHtml}${loveHtml}`;
            }

            async function updateHeaderInfo() {
                const trip = tripData[currentTripId]; if (!trip) return;
                const config = COUNTRY_CONFIG[trip.country || 'TW'] || COUNTRY_CONFIG['TW'];
                
                currentTripRate = await fetchExchangeRate(config.currency);
                const barSelect = document.getElementById('bar-calc-currency'); 
                if(barSelect) { barSelect.value = config.currency; calculateCurrency(); }
                document.getElementById('header-members-list').innerHTML = (trip.members && trip.members.length) ? trip.members.map((m, i) => `<span class="${MEMBER_COLORS[i % MEMBER_COLORS.length]} mr-1">${m}</span>`).join('') : 'å°šæœªè¨­å®š';

                const fetchWeather = async (lat, lon, displayName) => {
                    document.getElementById('header-location-name').textContent = displayName;
                    try { 
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`); 
                        const data = await res.json(); 
                        const code = data.current.weather_code;
                        let icon = code > 50 ? 'ğŸŒ§ï¸' : (code > 3 ? 'â˜ï¸' : 'â˜€ï¸'); 
                        document.getElementById('header-weather-icon').textContent = icon; 
                        const temp = data.current.temperature_2m;
                        document.getElementById('header-weather-temp').textContent = `${temp}Â°C`; 
                        let clothing = temp >= 25 ? 'ğŸ½ çŸ­è¢–' : (temp >= 20 ? 'ğŸ‘• è–„å¤–å¥—' : (temp >= 15 ? 'ğŸ§¥ å¤–å¥—' : (temp >= 10 ? 'ğŸ§¥ å¤§è¡£' : 'ğŸ§£ ç¾½çµ¨')));
                        document.getElementById('header-clothing-advice').textContent = clothing;
                    } catch (e) { }
                };

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            let localizedName = "ç›®å‰ä½ç½®";
                            try {
                                const geoRes = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=zh-tw`);
                                const geoData = await geoRes.json();
                                localizedName = geoData.city || geoData.locality || geoData.countryName || "ç›®å‰ä½ç½®";
                            } catch (e) { console.error(e); }
                            fetchWeather(lat, lon, localizedName);
                        },
                        () => { fetchWeather(config.lat, config.lon, config.localName); },
                        { timeout: 5000 }
                    );
                } else { fetchWeather(config.lat, config.lon, config.localName); }
            }

            function changeTrip(tripId) { 
                currentTripId = tripId; 
                const trip = tripData[tripId];
                if (trip) {
                    if (trip.startDate) {
                        const today = new Date(); today.setHours(0, 0, 0, 0);
                        const start = new Date(trip.startDate); start.setHours(0, 0, 0, 0);
                        const diffTimeTrip = today.getTime() - start.getTime();
                        const diffDaysTrip = Math.floor(diffTimeTrip / (1000 * 60 * 60 * 24));
                        const calculatedDay = diffDaysTrip + 1;
                        currentDayId = (calculatedDay >= 1 && calculatedDay <= (trip.numDays || 1)) ? `Day ${calculatedDay}` : 'Day 1';
                    } else currentDayId = 'Day 1';
                    updateHeaderInfo(); 
                    renderDayTabs(); 
                    loadSchedules(currentTripId, currentDayId); 
                    checkAndCreateDefaultLists(tripId); 
                }
            }

            function createTripCard(schedule) {
                const style = getCardStyle(schedule.Type);
                const config = CATEGORY_COLORS[schedule.Type] || CATEGORY_COLORS['default'];
                const rate = schedule.Rate || 1;
                const members = schedule.members || [];
                
                let calculatedTotalTW = 0;
                const uniquePayerNames = [...new Set(members.filter(m => m.isPayer).map(m => m.name))];
                const uniqueAmountEnteredNames = [...new Set(members.filter(m => parseFloat(m.amount) > 0).map(m => m.name))];
                const totalParticipantsNames = [...new Set(members.map(m => m.name))];

                members.forEach(m => {
                    const amt = parseFloat(m.amount) || 0;
                    const fee = parseFloat(m.fee) || 0;
                    const mValueTW = (m.method === 'card' ? (amt + fee) : (amt * rate));
                    calculatedTotalTW += mValueTW;
                });

                let splitDisplay = "ï¼";
                if (uniqueAmountEnteredNames.length === 1 && uniquePayerNames.length === 1 && uniqueAmountEnteredNames[0] === uniquePayerNames[0]) {
                    const perPerson = calculatedTotalTW / totalParticipantsNames.length;
                    splitDisplay = `TW$${perPerson.toFixed(0)}`;
                }
                
                let memberHtml = members.length > 0 ? `<div class="flex flex-nowrap overflow-hidden justify-end gap-x-1.5 ml-2 max-w-[120px]">` + totalParticipantsNames.map((name, i) => `<span class="${MEMBER_COLORS[i % MEMBER_COLORS.length]} text-[10px] font-bold whitespace-nowrap">${name}</span>`).join('') + `</div>` : '';
                const mustGoHtml = schedule.MustGo ? `<div class="mt-auto w-full flex justify-start mb-3"><span class="text-[9px] text-[#CB8572] border border-[#CB8572] px-1 py-0.5 rounded-[2px] leading-none bg-white">å¿…å»</span></div>` : '';

                const card = document.createElement('div');
                card.className = 'trip-card flex w-full mb-3 relative'; card.style.height = '100px'; 
                const visualWrapper = document.createElement('div'); visualWrapper.className = 'trip-card-visual-wrapper';
                const swipeActions = document.createElement('div'); swipeActions.className = 'swipe-item-delete-bg';
                const modBtn = document.createElement('button'); modBtn.className = "px-2 h-full text-xs font-bold bg-[#7E92A1] text-white"; modBtn.textContent = "ä¿®æ”¹"; modBtn.onclick = () => openEditScheduleModal(schedule);
                const delBtn = document.createElement('button'); delBtn.className = "px-2 h-full text-xs font-bold bg-[#CB8572] text-white"; delBtn.textContent = "åˆªé™¤"; delBtn.onclick = () => deleteSchedule(schedule.id);
                swipeActions.append(modBtn, delBtn); visualWrapper.appendChild(swipeActions);

                const content = document.createElement('div');
                content.className = 'swipe-item-content flex w-full bg-white relative items-stretch h-full z-10';
                content.innerHTML = `
                    <div class="${config.bg} w-14 flex-none flex flex-col items-center justify-start gap-2 text-white h-full py-3">
                        <span class="text-[10px] font-bold">${schedule.Time}</span>
                        <span class="text-2xl">${style.icon}</span>
                        <span class="text-[9px] font-medium opacity-90">${CATEGORY_NAMES[schedule.Type] || schedule.Type}</span>
                    </div>
                    <div class="flex-grow py-2 pl-2 pr-1 flex flex-col justify-start min-w-0 overflow-hidden">
                        <div class="flex justify-between items-start w-full">
                            <h3 class="text-xs font-bold text-[#4A4B4D] truncate"><a href="#" class="location-link hover:underline">${schedule.Location}</a></h3>
                            ${memberHtml}
                        </div>
                        <p class="text-[#888888] text-[10px] line-clamp-4 whitespace-pre-wrap mt-0.5" style="line-height: 1.2;">${schedule.èªªæ˜ || ''}</p>
                    </div>
                    <div class="card-right-col h-full flex flex-col">
                        <div class="card-static-actions"></div>
                        <div class="flex flex-col gap-1 mt-1">
                            <span class="text-[#8F9E8B] font-bold text-[10px]">ğŸ’° TW$${calculatedTotalTW.toFixed(0)}</span>
                            <span class="text-[#888888] font-bold text-[10px]">ğŸ‘« ${splitDisplay}</span>
                        </div>
                        ${mustGoHtml}
                    </div>`;
                
                const staticActions = content.querySelector('.card-static-actions');
                const sMod = document.createElement('button'); sMod.className = "bg-[#7E92A1] text-white rounded px-1.5 py-0.5 text-[9px] font-bold"; sMod.textContent="ä¿®æ”¹"; sMod.onclick=()=>openEditScheduleModal(schedule);
                const sDel = document.createElement('button'); sDel.className = "bg-[#CB8572] text-white rounded px-1.5 py-0.5 text-[9px] font-bold"; sDel.textContent="åˆªé™¤"; sDel.onclick=()=>deleteSchedule(schedule.id);
                staticActions.append(sMod, sDel); visualWrapper.appendChild(content); card.appendChild(visualWrapper);
                enableSwipeToDelete(content, swipeActions, 'schedule');
                return card;
            }

            const loadSchedules = (tripId, dayId) => {
                const container = document.getElementById('schedule-list-container');
                if (!tripId) {
                    container.innerHTML = '<div class="p-4 text-center text-[#A9A9A9] text-xs">è«‹é¸æ“‡è¨ˆç•«ã€‚</div>';
                    return;
                }
                if (unsubscribeSchedule) unsubscribeSchedule();
                container.innerHTML = '<div class="p-4 text-center text-[#A9A9A9] text-xs">è¡Œç¨‹åŠ è¼‰ä¸­...</div>';
                
                const q = query(
                    collection(db, `artifacts/${appId}/public/data/Trips/${tripId}/Schedules`), 
                    where('dayId', '==', dayId)
                );

                unsubscribeSchedule = onSnapshot(q, (snapshot) => {
                    // ç²å–å¿«ç…§å¾Œç«‹å³æ¸…ç©ºå®¹å™¨ï¼Œä¸è«–è³‡æ–™æ˜¯å¦ç‚ºç©º
                    container.innerHTML = '';
                    const trip = tripData[tripId]; 
                    if (trip && trip.startDate) {
                        try { updateHeaderDateWithDDay(getDateFromDayId(trip, dayId)); } catch (e) {}
                    }
                    
                    if (snapshot.empty) {
                        container.innerHTML = `<div class="p-4 text-center text-[#A9A9A9] text-xs">æ­¤æ—¥æš«ç„¡è¡Œç¨‹ã€‚</div>`;
                    } else {
                        const schedules = [];
                        snapshot.forEach(doc => schedules.push({ id: doc.id, ...doc.data() }));
                        schedules.sort((a, b) => (a.Time || "").localeCompare(b.Time || ""));
                        schedules.forEach(schedule => container.appendChild(createTripCard(schedule)));
                    }
                }, (error) => {
                    console.error("è¼‰å…¥å¤±æ•—:", error);
                    container.innerHTML = `<div class="p-4 text-center text-red-400 text-xs">è¼‰å…¥å‡ºéŒ¯ã€‚</div>`;
                });
            };

            const loadTripList = () => {
                const colRef = collection(db, `artifacts/${appId}/public/data/Trips`);
                unsubscribeTrips = onSnapshot(colRef, (snapshot) => {
                    const select = document.getElementById('trip-select'); select.innerHTML = ''; tripData = {}; let firstId = null;
                    snapshot.forEach(doc => { 
                        const d = doc.data(); tripData[doc.id] = { id: doc.id, ...d }; 
                        const op = document.createElement('option'); op.value = doc.id; op.textContent = d.name || 'æœªå‘½å'; select.appendChild(op); 
                        if(!firstId) firstId = doc.id; 
                    });
                    if (!currentTripId || !tripData[currentTripId]) currentTripId = firstId;
                    if (currentTripId) { 
                        select.value = currentTripId; 
                        changeTrip(currentTripId); 
                    } else {
                        document.getElementById('schedule-list-container').innerHTML = '<div class="p-4 text-center text-[#A9A9A9] text-xs">å°šç„¡è¡Œç¨‹ï¼Œé»æ“Š ğŸ“… å»ºç«‹ã€‚</div>';
                    }
                });
            };

            function renderDayTabs() {
                const container = document.getElementById('day-tabs-container'); container.innerHTML = '';
                const trip = tripData[currentTripId]; if (!trip) return;
                for (let i = 0; i < (trip.numDays || 1); i++) {
                    const dId = `Day ${i + 1}`; const btn = document.createElement('button');
                    btn.className = `px-3 py-1.5 text-xs font-bold rounded-lg transition flex-shrink-0 ${dId === currentDayId ? 'bg-[#5F6368] text-white' : 'bg-[#E4E6E8] text-[#5F6368]'}`;
                    btn.textContent = dId; btn.onclick = () => { currentDayId = dId; renderDayTabs(); loadSchedules(currentTripId, currentDayId); };
                    container.appendChild(btn);
                }
                const addBtn = document.createElement('button'); addBtn.className = 'px-3 py-1.5 text-xs font-bold rounded-lg bg-[#7E92A1] text-white ml-2 flex-shrink-0'; addBtn.textContent = '+';
                addBtn.onclick = async () => await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}`), { numDays: (trip.numDays || 1) + 1 }, { merge: true });
                container.appendChild(addBtn);
            }

            async function calculateCurrency() {
                const code = document.getElementById('bar-calc-currency').value; const amt = parseFloat(document.getElementById('bar-calc-amount').value) || 0;
                const rate = await fetchExchangeRate(code);
                document.getElementById('rate-display-label').textContent = `åŒ¯ç‡ â‰ˆ ${code} ${(1/rate).toFixed(2)}`;
                document.getElementById('bar-calc-result').value = amt === 0 ? '' : (amt * rate).toFixed(0);
            }

            function enableSwipeToDelete(contentEl, actionEl, type) {
                if (window.innerWidth > 500) return; 
                let startX = 0, currentTranslate = 0, isSwiping = false;
                contentEl.addEventListener('touchstart', e => { startX = e.touches[0].clientX; isSwiping = false; }, {passive: true});
                contentEl.addEventListener('touchmove', e => { 
                    const diffX = e.touches[0].clientX - startX; 
                    if (Math.abs(diffX) < 10) return;
                    if (diffX < 0) { isSwiping = true; currentTranslate = Math.max(diffX, -140); contentEl.style.transform = `translateX(${currentTranslate}px)`; }
                }, {passive: true});
                contentEl.addEventListener('touchend', () => { contentEl.style.transform = (isSwiping && currentTranslate < -70) ? `translateX(-140px)` : `translateX(0)`; });
            }

            // --- ä¿®æ”¹è¡Œç¨‹ä¸»è¦è¨­å®š ---
            function openSettingsModal() {
                const trip = tripData[currentTripId];
                if (!trip) return;
                const modal = document.getElementById('settings-modal');
                const content = modal.querySelector('div');

                content.innerHTML = `<h3 class="text-base font-bold mb-3 flex justify-between items-center text-[#4A4B4D]">è¨ˆç•«è¨­å®š <button id="settings-modal-close-btn" class="text-[#A9A9A9] text-xl">Ã—</button></h3><form id="settings-form" class="space-y-3"><div><label class="block text-xs font-medium text-[#7E92A1]">è¨ˆç•«åç¨±</label><input type="text" id="settings-trip-name" class="compact-input mt-0.5 block w-full rounded border"></div><div class="grid grid-cols-[0.8fr_1.5fr_0.7fr] gap-1"><div><label class="block text-xs font-medium text-[#7E92A1]">åœ‹å®¶</label><select id="settings-trip-country" class="compact-input mt-0.5 block w-full rounded border h-[28px]"><option value="USA">ğŸ‡ºğŸ‡¸ ç¾åœ‹</option><option value="JP">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option><option value="KR">ğŸ‡°ğŸ‡· éŸ“åœ‹</option><option value="UK">ğŸ‡¬ğŸ‡§ è‹±åœ‹</option><option value="TW">ğŸ‡¹ğŸ‡¼ å°ç£</option></select></div><div><label class="block text-xs font-medium text-[#7E92A1]">é–‹å§‹æ—¥æœŸ</label><input type="date" id="settings-start-date" class="compact-input mt-0.5 block w-full rounded border text-[10px] h-[28px]"></div><div><label class="block text-xs font-medium text-[#7E92A1]">å¤©æ•¸</label><input type="number" id="settings-num-days" min="1" class="compact-input mt-0.5 block w-full rounded border text-center h-[28px]"></div></div><div><label class="block text-xs font-medium text-[#7E92A1] mb-1">æˆå“¡</label><div id="settings-members-container" class="grid grid-cols-3 gap-2"></div><button type="button" id="settings-add-member-btn" class="mt-2 text-[10px] text-[#7E92A1]">+ æ–°å¢æˆå“¡</button></div><div class="pt-3 flex justify-between items-center border-t border-gray-100 mt-2"><button type="button" id="new-trip-from-settings-btn" class="px-3 py-1.5 text-xs text-[#7E92A1] bg-[#EBF2FA] rounded">æ–°è¨ˆç•«</button><div class="flex space-x-2"><button type="button" id="delete-trip-btn" class="px-3 py-1.5 text-white bg-[#CB8572] rounded text-xs">åˆªé™¤</button><button type="button" id="settings-modal-save-btn" class="px-3 py-1.5 text-white bg-[#7E92A1] rounded text-xs">å„²å­˜</button></div></div></form>`;

                document.getElementById('settings-trip-name').value = trip.name || '';
                document.getElementById('settings-trip-country').value = trip.country || 'TW';
                document.getElementById('settings-start-date').value = trip.startDate || '';
                document.getElementById('settings-num-days').value = trip.numDays || 1;

                const memCont = document.getElementById('settings-members-container');
                const addMemInput = (val = '') => {
                    const div = document.createElement('div');
                    div.className = "flex items-center bg-gray-50 rounded border";
                    div.innerHTML = `<input type="text" class="setting-mem-input w-full bg-transparent text-[10px] p-1 text-center" value="${val}"><button type="button" class="px-1 text-[#CB8572]" onclick="this.parentElement.remove()">Ã—</button>`;
                    memCont.appendChild(div);
                };
                (trip.members || []).forEach(m => addMemInput(m));

                modal.style.display = 'flex';

                document.getElementById('settings-modal-close-btn').onclick = () => modal.style.display = 'none';
                document.getElementById('settings-add-member-btn').onclick = () => addMemInput();
                document.getElementById('new-trip-from-settings-btn').onclick = () => { modal.style.display = 'none'; openNewTripModal(); };
                document.getElementById('delete-trip-btn').onclick = async () => { if(confirm('ç¢ºå®šè¦åˆªé™¤æ•´å€‹è¡Œç¨‹å—ï¼Ÿæ­¤å‹•ä½œä¸å¯å¾©åŸã€‚')) { await deleteDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}`)); modal.style.display = 'none'; location.reload(); } };
                document.getElementById('settings-modal-save-btn').onclick = async () => {
                    const members = Array.from(document.querySelectorAll('.setting-mem-input')).map(i => i.value.trim()).filter(v => v);
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}`), {
                        name: document.getElementById('settings-trip-name').value,
                        country: document.getElementById('settings-trip-country').value,
                        startDate: document.getElementById('settings-start-date').value,
                        numDays: parseInt(document.getElementById('settings-num-days').value) || 1,
                        members
                    });
                    modal.style.display = 'none'; changeTrip(currentTripId);
                };
            }

            // --- æ–°å¢è¨ˆç•«è¦–çª— ---
            function openNewTripModal() {
                const modal = document.getElementById('new-trip-modal');
                const content = modal.querySelector('div');
                
                content.innerHTML = `<h3 class="text-base font-bold mb-3 flex justify-between items-center text-[#4A4B4D]">æ–°å¢è¨ˆç•«<button id="new-trip-modal-close-btn" class="text-[#A9A9A9] text-xl">Ã—</button></h3><form id="new-trip-form" class="space-y-3"><div><label class="block text-xs font-medium text-[#7E92A1]">åç¨±</label><input type="text" id="new-trip-name" class="compact-input block w-full rounded border"></div><div class="grid grid-cols-[0.8fr_1.5fr_0.7fr] gap-1"><div><label class="block text-xs font-medium text-[#7E92A1]">åœ‹å®¶</label><select id="new-trip-country" class="compact-input block w-full rounded border h-[28px]"><option value="USA">ğŸ‡ºğŸ‡¸ ç¾åœ‹</option><option value="JP">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option><option value="KR">ğŸ‡°ğŸ‡· éŸ“åœ‹</option><option value="UK">ğŸ‡¬ğŸ‡§ è‹±åœ‹</option><option value="TW">ğŸ‡¹ğŸ‡¼ å°ç£</option></select></div><div><label class="block text-xs font-medium text-[#7E92A1]">æ—¥æœŸ</label><input type="date" id="new-trip-start-date" class="compact-input block w-full rounded border text-[10px] h-[28px]"></div><div><label class="block text-xs font-medium text-[#7E92A1]">å¤©æ•¸</label><input type="number" id="new-trip-days" min="1" class="compact-input block w-full rounded border text-center h-[28px]" value="1"></div></div><div class="pt-3 flex justify-end"><button type="button" id="new-trip-modal-save-btn" class="px-3 py-1.5 text-white bg-[#7E92A1] rounded text-xs">æ–°å¢</button></div></form>`;

                modal.style.display = 'flex';

                document.getElementById('new-trip-modal-close-btn').onclick = () => modal.style.display = 'none';
                document.getElementById('new-trip-modal-save-btn').onclick = async () => {
                    const name = document.getElementById('new-trip-name').value.trim();
                    const startDate = document.getElementById('new-trip-start-date').value;
                    if (!name || !startDate) return alert('åç¨±èˆ‡æ—¥æœŸå¿…å¡«');
                    const newDoc = await addDoc(collection(db, `artifacts/${appId}/public/data/Trips`), {
                        name, startDate, 
                        country: document.getElementById('new-trip-country').value,
                        numDays: parseInt(document.getElementById('new-trip-days').value) || 1,
                        members: [], uid: currentUser.uid
                    });
                    modal.style.display = 'none'; changeTrip(newDoc.id);
                };
            }

            function addToCalendar(event) {
                const title = event.Location || 'è¡Œç¨‹';
                const desc = event.èªªæ˜ || '';
                const loc = event.Address || '';
                const startDateStr = event.Date.replace(/-/g, '');
                const startTimeStr = event.Time.replace(/:/g, '') + '00';
                
                const iContent = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'PRODID:-//Trip Compass//Calendar Event//EN',
                    'BEGIN:VEVENT',
                    `DTSTART:${startDateStr}T${startTimeStr}`,
                    `DTEND:${startDateStr}T${startTimeStr}`, 
                    `SUMMARY:${title}`,
                    `DESCRIPTION:${desc}`,
                    `LOCATION:${loc}`,
                    'BEGIN:VALARM',
                    'TRIGGER:-PT15M', 
                    'ACTION:DISPLAY',
                    'DESCRIPTION:Reminder',
                    'END:VALARM',
                    'END:VEVENT',
                    'END:VCALENDAR'
                ].join('\n');

                const blob = new Blob([iContent], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${title}.ics`;
                link.click();
                URL.revokeObjectURL(url);
            }

            // --- å³æ™‚è¨ˆå¸³åˆ·æ–°é‚è¼¯ ---
            function refreshModalTotals() {
                let sumTW = 0;
                let sumLocal = 0;
                const memberRows = document.getElementById('form-members-container').querySelectorAll('.member-row');

                memberRows.forEach(row => {
                    const amountInput = row.querySelector('input[name="schedule-member-amount"]');
                    const amount = parseFloat(amountInput.value) || 0;
                    const fee = parseFloat(row.querySelector('.member-fee-input').value) || 0;
                    const method = row.querySelector('.payment-method').value;

                    if (method === 'card') {
                        sumTW += (amount + fee);
                        sumLocal += (amount + fee) / currentTripRate;
                    } else {
                        sumTW += (amount * currentTripRate);
                        sumLocal += amount;
                    }
                });

                const localField = document.getElementById('form-amount-local');
                const twdFieldDisplay = document.getElementById('form-amount-twd-display');
                if(localField) localField.value = sumLocal > 0 ? sumLocal.toFixed(0) : '0';
                if(twdFieldDisplay) twdFieldDisplay.value = sumTW > 0 ? sumTW.toFixed(0) : '0';
                
                const twdFieldHidden = document.getElementById('form-amount-twd-hidden');
                if(twdFieldHidden) twdFieldHidden.value = sumTW;
            }

            function openEditScheduleModal(s) {
                editingScheduleId = s.id;
                const modal = document.getElementById('add-schedule-modal');
                const content = modal.querySelector('div');
                const trip = tripData[currentTripId];
                const config = COUNTRY_CONFIG[trip ? trip.country : 'TW'] || COUNTRY_CONFIG['TW'];
                
                content.innerHTML = `
                    <h3 class="text-base font-bold mb-2 text-[#4A4B4D] pr-8 truncate"><span id="add-schedule-modal-title">${s.Location || 'ç·¨è¼¯è¡Œç¨‹'}</span></h3>
                    <button id="modal-close-btn" class="absolute top-3 right-3 text-[#A9A9A9] text-2xl leading-none">Ã—</button>
                    <form id="add-schedule-form" class="space-y-2">
                        <div class="grid grid-cols-3 gap-1.5"> 
                            <div><label class="compact-label block text-left">æ—¥æœŸ</label><input type="date" id="form-date" class="compact-input w-full rounded border" value="${s.Date||''}"></div> 
                            <div><label class="compact-label block text-left">æ™‚é–“</label><input type="time" id="form-time" class="compact-input w-full rounded border" value="${s.Time||''}"></div>
                            <div><label class="compact-label block text-left">é¡å‹</label><select id="form-type" class="compact-input w-full rounded border">
                                <option value="location" ${s.Type==='location'?'selected':''}>ğŸ“ æ™¯é»</option>
                                <option value="restaurant" ${s.Type==='restaurant'?'selected':''}>ğŸ½ï¸ é¤å»³</option>
                                <option value="coffee" ${s.Type==='coffee'?'selected':''}>â˜• å’–å•¡</option>
                                <option value="accommodation" ${s.Type==='accommodation'?'selected':''}>ğŸ›ï¸ ä½å®¿</option>
                                <option value="äº¤é€š" ${s.Type==='äº¤é€š'?'selected':''}>ğŸš— äº¤é€š</option>
                                <option value="shopping" ${s.Type==='shopping'?'selected':''}>ğŸ›ï¸ è³¼ç‰©</option>
                            </select></div>
                        </div>
                        <div class="flex gap-2 items-center">
                            <div class="flex-grow"><label class="compact-label">åœ°é»</label><input type="text" id="form-location" class="compact-input w-full rounded border" value="${s.Location||''}"></div>
                            <div class="flex gap-3 items-center">
                                <div class="flex flex-col items-center"><span class="compact-label text-[10px] text-[#CB8572]">å¿…å»</span><input type="checkbox" id="form-must-go" ${s.MustGo?'checked':''}></div>
                                <div class="flex flex-col items-center"><span class="compact-label text-[10px] text-[#7E92A1]">é¬§é˜</span><input type="checkbox" id="form-remind"></div>
                            </div>
                        </div>
                        <div><label class="compact-label">åœ°å€</label><input type="text" id="form-address" class="compact-input w-full rounded border" value="${s.Address||''}"></div>
                        <div><label class="compact-label">å‚™è¨»å…§å®¹</label><textarea id="form-details" rows="4" class="w-full rounded border p-1 text-[11px] text-[#5F6368] border-[#E0E0E0]" style="line-height: 1.2;" placeholder="å‚™è¨»å…§å®¹...">${s.èªªæ˜||''}</textarea></div>
                        <div class="bg-gray-50 p-2 rounded border">
                            <div class="flex items-center mb-1 gap-2"><label class="compact-label">æˆå“¡</label><button type="button" id="add-member-btn" class="text-[#7E92A1] text-xs font-bold">ï¼‹</button></div>
                            <div id="form-members-container" class="space-y-1 mb-2"></div>
                            <div class="flex items-center justify-between mt-2 border-t pt-2 w-full px-2">
                                <div class="text-[0.7rem] font-bold text-[#7E92A1] flex-none">${config.currency}</div>
                                <input type="text" id="form-amount-local" readonly class="w-20 bg-transparent border-none p-0 text-center focus:ring-0 font-bold text-[0.7rem] text-[#7E92A1] flex-none" value="0">
                                <div class="text-gray-400 font-bold flex-none text-[0.7rem]">=</div>
                                <div class="flex items-center gap-1 flex-none">
                                    <span class="text-[#A9A9A9] text-[0.7rem] font-bold">TW$</span>
                                    <input type="text" id="form-amount-twd-display" readonly class="w-20 bg-transparent border-none p-0 text-right focus:ring-0 font-bold text-[0.7rem] text-[#7E92A1]" value="0">
                                </div>
                                <input type="hidden" id="form-amount-twd-hidden" value="0">
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-2 border-t">
                            <button type="button" id="modal-delete-btn" class="px-3 py-1 bg-[#CB8572] text-white rounded text-xs font-bold ${editingScheduleId?'':'hidden'}">åˆªé™¤</button>
                            <button type="button" id="modal-save-btn" class="px-3 py-1 bg-[#7E92A1] text-white rounded text-xs font-bold shadow-sm">å„²å­˜</button>
                        </div>
                    </form>`;
                
                const memCont = content.querySelector('#form-members-container');
                (s.members || []).forEach(m => addMemberInput(typeof m === 'string' ? m : m.name, m.amount, m.isPayer || false, m.method || 'cash', m.fee));
                if(!(s.members || []).length) { addMemberInput(); addMemberInput(); }

                document.getElementById('modal-close-btn').onclick = () => modal.style.display = 'none';
                document.getElementById('modal-save-btn').onclick = submitSchedule;
                document.getElementById('modal-delete-btn').onclick = () => deleteSchedule(s.id);
                document.getElementById('add-member-btn').onclick = () => addMemberInput();

                refreshModalTotals();
                modal.style.display = 'flex';
            }

            function addMemberInput(name='', amt='', isPayer=false, method='cash', fee='') {
                const d = document.createElement('div'); 
                d.className = 'member-row flex items-center w-full gap-2 border-b pb-1 last:border-0';
                d.innerHTML = `
                    <input type="text" name="schedule-member-name" value="${name}" placeholder="åå­—" class="compact-input w-16 rounded-md font-bold text-[0.7rem]">
                    <input type="number" name="schedule-member-amount" value="${amt !== null ? amt : ''}" placeholder="é‡‘é¡" class="compact-input w-20 rounded-md text-[0.7rem]">
                    <div class="flex items-center gap-1">
                        <label class="flex items-center text-[0.7rem] text-[#7E92A1] cursor-pointer whitespace-nowrap"><input type="checkbox" class="payer-check mr-1 h-4 w-4" ${isPayer?'checked':''}>å…ˆä»˜</label>
                        <select class="payment-method text-[0.7rem] border rounded px-1 h-6 text-center">
                            <option value="cash" ${method==='cash'?'selected':''}>ç¾é‡‘</option>
                            <option value="card" ${method==='card'?'selected':''}>åˆ·å¡</option>
                        </select>
                        <input type="number" name="schedule-member-fee" value="${fee !== undefined ? fee : ''}" placeholder="æ‰‹çºŒ" class="member-fee-input compact-input w-10 rounded-md text-[0.7rem] ${method==='card'?'':'hidden'}">
                    </div>
                    <button type="button" class="text-[#CB8572] font-bold p-1 ml-auto text-lg">Ã—</button>`;
                
                const sel = d.querySelector('.payment-method');
                const feeInp = d.querySelector('.member-fee-input');
                const amtInp = d.querySelector('input[name="schedule-member-amount"]');
                const payerCheck = d.querySelector('.payer-check');

                const triggerRefresh = () => refreshModalTotals();
                sel.onchange = (e) => {
                    if (e.target.value === 'card') {
                        feeInp.classList.remove('hidden');
                    } else {
                        feeInp.classList.add('hidden');
                        feeInp.value = '';
                    }
                    triggerRefresh();
                };
                amtInp.oninput = triggerRefresh;
                feeInp.oninput = triggerRefresh;
                payerCheck.onchange = triggerRefresh;
                
                d.querySelector('button').onclick = () => { d.remove(); triggerRefresh(); };
                document.getElementById('form-members-container').appendChild(d);
            }

            async function submitSchedule() {
                const dateVal = document.getElementById('form-date').value; if (!dateVal) return alert("è«‹é¸æ—¥æœŸ");
                const trip = tripData[currentTripId];
                const dayId = `Day ${dateDiffInDays(new Date(dateVal), new Date(trip.startDate)) + 1}`;
                const members = [];
                document.getElementById('form-members-container').querySelectorAll('.member-row').forEach(row => {
                    const name = row.querySelector('input[name="schedule-member-name"]').value.trim();
                    const amt = row.querySelector('input[name="schedule-member-amount"]').value;
                    const fee = row.querySelector('.member-fee-input').value;
                    if (name) members.push({ 
                        name, 
                        amount: amt !== "" ? parseFloat(amt) : null, 
                        isPayer: row.querySelector('.payer-check').checked, 
                        method: row.querySelector('.payment-method').value,
                        fee: fee !== "" ? parseFloat(fee) : 0
                    });
                });

                const data = { 
                    dayId, Date: dateVal, Time: document.getElementById('form-time').value, Location: document.getElementById('form-location').value,
                    Type: document.getElementById('form-type').value, èªªæ˜: document.getElementById('form-details').value,
                    Address: document.getElementById('form-address').value, 
                    Amount: parseFloat(document.getElementById('form-amount-twd-hidden').value) || 0, 
                    Rate: currentTripRate,
                    members, MustGo: document.getElementById('form-must-go').checked, uid: currentUser.uid
                };
                
                const col = collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`);
                if (editingScheduleId) await updateDoc(doc(col, editingScheduleId), data); else await addDoc(col, data);
                
                if (document.getElementById('form-remind').checked) addToCalendar(data);

                document.getElementById('add-schedule-modal').style.display = 'none'; loadSchedules(currentTripId, dayId);
            }

            async function checkAndCreateDefaultLists(tripId) {
                const col = collection(db, `artifacts/${appId}/public/data/Trips/${tripId}/Lists`);
                const snap = await getDocs(col);
                if (snap.empty) {
                    await addDoc(col, {name: 'ç‰©å“', type: 'check', order: 1, items:[], uid: currentUser.uid});
                    await addDoc(col, {name: 'è³¼ç‰©', type: 'shopping', order: 2, items:[], uid: currentUser.uid});
                }
            }

            function loadLists() {
                const listModal = document.getElementById('lists-modal'); listModal.style.display = 'flex';
                if(unsubscribeLists) unsubscribeLists();
                unsubscribeLists = onSnapshot(query(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists`), orderBy('order')), (snap) => {
                    const tabs = document.getElementById('list-tabs'); const cont = document.getElementById('list-content');
                    tabs.innerHTML = ''; cont.innerHTML = '';
                    const lists = []; snap.forEach(d => lists.push({id: d.id, ...d.data()}));
                    if(!lists.length) { renderAddTabButton(tabs); return; }
                    if(!currentListTabId || !lists.find(l=>l.id===currentListTabId)) currentListTabId = lists[0].id;
                    lists.forEach(l => {
                        const t = document.createElement('div'); const isActive = l.id === currentListTabId;
                        t.className = `cursor-pointer px-3 py-2 text-sm flex-shrink-0 whitespace-nowrap transition-all ${isActive ? 'border-b-2 border-[#7E92A1] text-[#7E92A1] font-bold' : 'text-[#A9A9A9]'}`;
                        if (isActive) {
                            const inp = document.createElement('input'); inp.type = 'text'; inp.value = l.name; inp.className = 'bg-transparent border-none focus:ring-0 p-0 w-20 font-bold text-[#7E92A1] text-sm text-center';
                            inp.onblur = async () => {
                                const newName = inp.value.trim();
                                if (newName === "") {
                                    if(confirm(`è¦åˆªé™¤æ¸…å–®ã€Œ${l.name}ã€å—ï¼Ÿ`)) { await deleteDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${l.id}`)); currentListTabId = null; }
                                    else { inp.value = l.name; }
                                } else if (newName !== l.name) { await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${l.id}`), { name: newName }); }
                            };
                            inp.onkeydown = (e) => { if(e.key === 'Enter') inp.blur(); }; t.appendChild(inp);
                        } else { t.textContent = l.name; t.onclick = () => { currentListTabId = l.id; loadLists(); }; }
                        tabs.appendChild(t);
                    });
                    renderAddTabButton(tabs);
                    const target = lists.find(l => l.id === currentListTabId); if (target) renderListItems(target, cont);
                });
            }

            function renderAddTabButton(tabsContainer) {
                const addTab = document.createElement('button');
                addTab.className = 'px-3 py-2 text-[#7E92A1] text-xl font-bold leading-none flex-shrink-0';
                addTab.textContent = '+';
                addTab.onclick = async () => {
                    const name = prompt("è«‹è¼¸å…¥æ–°æ¸…å–®åç¨±ï¼š", "æ–°æ¸…å–®");
                    if (!name) return;
                    const type = confirm("å»ºç«‹ã€ç‰©å“æ¸…å–®ã€(ç¢ºå®š) é‚„æ˜¯ ã€è³¼ç‰©æ¸…å–®ã€(å–æ¶ˆ)ï¼Ÿ") ? 'check' : 'shopping';
                    const col = collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists`);
                    const snap = await getDocs(col);
                    await addDoc(col, { name, type, order: snap.size + 1, items: [], uid: currentUser.uid });
                };
                tabsContainer.appendChild(addTab);
            }

            function renderListItems(listData, container) {
                const modalBody = container.parentElement; modalBody.style.position = 'relative';
                const oldFab = modalBody.querySelector('.list-fab-dynamic'); if(oldFab) oldFab.remove();
                const fab = document.createElement('div'); fab.className = 'list-fab-dynamic'; fab.textContent = 'ï¼‹';
                fab.style.cssText = `position: absolute; bottom: 20px; right: 20px; width: 44px; height: 44px; background-color: #7E92A1; border-radius: 50%; color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.25); cursor: pointer; z-index: 50;`;
                fab.onclick = async () => {
                    const newItem = listData.type === 'check' 
                        ? { id: Date.now(), text: '', checkedLeft: false, checkedRight: false, isImportant: false } 
                        : { id: Date.now(), text: '', desc: '', location: '', imageUrl: '', isImportant: false };
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Lists/${listData.id}`), { items: [...(listData.items||[]), newItem] });
                };
                modalBody.appendChild(fab);

                const inner = document.createElement('div'); 
                inner.className = listData.type === 'check' ? 'grid grid-cols-2 gap-2 pb-16 mt-2' : 'space-y-2 pb-16 mt-2';
                
                const itemsWithOriginalIdx = (listData.items || []).map((item, index) => ({...item, originalIdx: index}));
                itemsWithOriginalIdx.sort((a, b) => (b.isImportant ? 1 : 0) - (a.isImportant ? 1 : 0));

                itemsWithOriginalIdx.forEach((item) => {
                    const idx = item.originalIdx;
                    const wrap = document.createElement('div'); wrap.className = 'swipe-item-container';
                    const bg = document.createElement('div'); bg.className = 'swipe-item-delete-bg'; bg.innerHTML = `<button class="px-2 h-full bg-[#CB8572] text-white font-bold text-xs">åˆªé™¤</button>`;
                    bg.querySelector('button').onclick = () => deleteListItem(listData, idx);
                    const c = document.createElement('div'); 
                    c.className = 'swipe-item-content bg-white py-1 px-2 border border-gray-100 rounded-lg flex items-center gap-2';
                    const star = `<button class="${item.isImportant?'text-yellow-400':'text-gray-200'} text-lg">${item.isImportant?'â˜…':'â˜†'}</button>`;
                    if(listData.type==='check') {
                        c.innerHTML = `
                            ${star}
                            <div class="flex gap-1 flex-none">
                                <input type="checkbox" ${item.checkedLeft?'checked':''} class="checkL">
                                <input type="checkbox" ${item.checkedRight?'checked':''} class="checkR">
                            </div>
                            <input type="text" value="${item.text||''}" class="txt border-none text-xs focus:ring-0 flex-1 min-w-0">
                            <button class="del text-gray-300 ml-1 desktop-del-btn font-bold text-lg flex-none">Ã—</button>`;
                        c.querySelector('button').onclick = () => updateListItem(listData, idx, {isImportant: !item.isImportant});
                        c.querySelector('.checkL').onchange = (e) => updateListItem(listData, idx, {checkedLeft: e.target.checked});
                        c.querySelector('.checkR').onchange = (e) => updateListItem(listData, idx, {checkedRight: e.target.checked});
                        c.querySelector('.txt').onchange = (e) => updateListItem(listData, idx, {text: e.target.value});
                        c.querySelector('.del').onclick = () => deleteListItem(listData, idx);
                    } else {
                        c.style.display = 'grid'; c.style.gridTemplateColumns = '24px 50px 1fr 60px 20px';
                        c.innerHTML = `
                            ${star}
                            <div class="shopping-img-box">${item.imageUrl?`<img src="${item.imageUrl}" class="w-full h-full object-cover">`:'ğŸ“·'}</div>
                            <div class="flex flex-col min-w-0 pr-1 border-r border-gray-50 justify-center">
                                <input type="text" value="${item.text||''}" class="name font-bold text-xs border-none p-0 focus:ring-0 truncate" placeholder="å“å">
                                <textarea class="desc text-[9px] text-gray-400 border-none p-0 focus:ring-0 resize-none h-8 w-full bg-transparent leading-tight no-scrollbar" placeholder="èªªæ˜">${item.desc||''}</textarea>
                            </div>
                            <div class="flex items-center pl-1">
                                <textarea class="loc text-[9px] text-gray-400 border-none p-0 focus:ring-0 resize-none h-10 w-full bg-transparent leading-tight no-scrollbar" placeholder="åœ°é»">${item.location||''}</textarea>
                            </div>
                            <button class="del text-gray-200">Ã—</button>`;
                        c.querySelector('button').onclick = () => updateListItem(listData, idx, {isImportant: !item.isImportant});
                        c.querySelector('.name').onchange = (e) => updateListItem(listData, idx, {text: e.target.value});
                        c.querySelector('.desc').onchange = (e) => updateListItem(listData, idx, {desc: e.target.value});
                        c.querySelector('.loc').onchange = (e) => updateListItem(listData, idx, {location: e.target.value});
                        c.querySelector('.del').onclick = () => deleteListItem(listData, idx);
                        c.querySelector('.shopping-img-box').onclick = () => {
                            if(item.imageUrl) { document.getElementById('zoom-img').src=item.imageUrl; document.getElementById('image-zoom-modal').style.display='flex'; }
                            else {
                                const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
                                inp.onchange = (e) => {
                                    const fr = new FileReader(); fr.onload=(ev)=>{
                                        const img=new Image(); img.onload=()=>{
                                            const cvs=document.createElement('canvas'); const s=400/img.width; cvs.width=400; cvs.height=img.height*s;
                                            cvs.getContext('2d').drawImage(img,0,0,400,cvs.height);
                                            updateListItem(listData,idx,{imageUrl:cvs.toDataURL("image/jpeg",0.7)});
                                        }; img.src=ev.target.result;
                                    }; fr.readAsDataURL(e.target.files[0]);
                                }; inp.click();
                            }
                        };
                    }
                    wrap.append(bg, c); inner.appendChild(wrap);
                    enableSwipeToDelete(c, bg, 'list');
                });
                container.appendChild(inner);
            }

            // --- æ ¸å¿ƒåˆ†å¸³èˆ‡çµç®—é‚è¼¯ ---
            async function loadExpenseSummary() {
                if(!currentTripId) return;
                const snap = await getDocs(collection(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`));
                let total=0, types={}, mems={}, balances={};
                
                snap.forEach(d => {
                    const da = d.data(); 
                    const rateVal = parseFloat(da.Rate) || 1; 
                    const members = da.members || [];
                    if (!members.length) return;

                    const scheduleTotalTW = members.reduce((sum, m) => {
                        const amt = parseFloat(m.amount) || 0;
                        const fee = parseFloat(m.fee) || 0;
                        return sum + (m.method === 'card' ? (amt + fee) : (amt * rateVal));
                    }, 0);

                    if (scheduleTotalTW <= 0) return;
                    total += scheduleTotalTW;
                    types[da.Type] = (types[da.Type] || 0) + scheduleTotalTW;

                    const uniqueParticipantNames = [...new Set(members.map(m => m.name))];
                    const numParticipants = uniqueParticipantNames.length;

                    const consumptionMap = {};
                    uniqueParticipantNames.forEach(n => consumptionMap[n] = 0);

                    const uniqueAmountNames = [...new Set(members.filter(m => parseFloat(m.amount) > 0).map(m => m.name))];
                    const uniquePayerNames = [...new Set(members.filter(m => m.isPayer).map(m => m.name))];

                    members.forEach(m => {
                        const amt = parseFloat(m.amount) || 0;
                        const fee = parseFloat(m.fee) || 0;
                        const valTW = (m.method === 'card' ? (amt + fee) : (amt * rateVal));

                        if (uniqueAmountNames.length === 1 && uniquePayerNames.length === 1 && uniqueAmountNames[0] === uniquePayerNames[0]) {
                            if (m.name === uniqueAmountNames[0] && amt > 0) {
                                uniqueParticipantNames.forEach(name => {
                                    consumptionMap[name] += valTW / numParticipants;
                                });
                            }
                        } else {
                            consumptionMap[m.name] += valTW;
                        }
                    });

                    uniqueParticipantNames.forEach(name => {
                        if(!mems[name]) mems[name] = { total: 0, cats: {} };
                        const consumed = consumptionMap[name];
                        mems[name].total += consumed;
                        mems[name].cats[da.Type] = (mems[name].cats[da.Type] || 0) + consumed;

                        if (uniquePayerNames.length > 0) {
                            let paidByThisMember = uniquePayerNames.includes(name) ? (scheduleTotalTW / uniquePayerNames.length) : 0;
                            balances[name] = (balances[name] || 0) + (paidByThisMember - consumed);
                        }
                    });
                });

                const modal = document.getElementById('split-expense-modal');
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm flex flex-col max-h-[90vh]">
                        <div class="flex justify-between items-center mb-3"><h3 class="font-bold text-[#4A4B4D]">èŠ±è²»</h3><button id="exp-close" class="text-2xl text-gray-400">Ã—</button></div>
                        <div class="bg-[#F9F9F9] p-3 rounded-xl border mb-3">
                            <div class="flex justify-between items-end border-b pb-1 mb-2"><span class="text-xs text-gray-500">ç¸½æ”¯å‡º</span><span class="font-extrabold text-sm text-[#4A4B4D]">TW$ ${total.toFixed(0)}</span></div>
                            <div class="grid grid-cols-[25%_50%_25%] items-center h-44">
                                <div id="leg-L" class="flex flex-col text-[10px] overflow-hidden h-full justify-start"></div>
                                <div class="flex justify-center items-center h-full"><canvas id="exp-chart" style="max-width: 100%; max-height: 100%;"></canvas></div>
                                <div id="leg-R" class="flex flex-col text-[10px] overflow-hidden h-full justify-start items-end"></div>
                            </div>
                        </div>
                        <div class="overflow-y-auto flex-grow space-y-2">
                            <div id="exp-mem-list" class="grid grid-cols-2 gap-x-10 gap-y-4 text-[11px]"></div>
                            <div id="settlement" class="mt-4 space-y-1"></div>
                        </div>
                    </div>`;
                
                document.getElementById('exp-close').onclick = () => modal.style.display = 'none';
                const sortedKeys = Object.keys(types).sort((a,b)=>types[b]-types[a]);
                expenseChart = new Chart(document.getElementById('exp-chart'), {
                    type: 'doughnut',
                    data: { datasets: [{ data: sortedKeys.map(k=>types[k]), backgroundColor: sortedKeys.map(k=>(CATEGORY_COLORS[k]||CATEGORY_COLORS.default).hex), borderWidth: 0 }] },
                    options: { maintainAspectRatio: false, cutout: '65%', plugins: { legend: { display: false } } }
                });
                
                sortedKeys.forEach((k, i) => {
                    const color = (CATEGORY_COLORS[k]||CATEGORY_COLORS.default).hex;
                    const isLeft = i % 2 === 0;
                    const rowHtml = `<div class="flex items-center gap-1.5 h-12">${isLeft ? `<div class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: ${color}"></div><div class="flex flex-col min-w-0"><span class="font-bold truncate text-[10px]">${CATEGORY_NAMES[k]||k}</span><span class="text-gray-400 text-[9px]">TW$${types[k].toFixed(0)}</span></div>` : `<div class="flex flex-col min-w-0 items-end text-right"><span class="font-bold truncate text-[10px]">${CATEGORY_NAMES[k]||k}</span><span class="text-gray-400 text-[9px]">TW$${types[k].toFixed(0)}</span></div><div class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: ${color}"></div>`}</div>`;
                    if(isLeft) document.getElementById('leg-L').innerHTML += rowHtml; else document.getElementById('leg-R').innerHTML += rowHtml;
                });

                Object.keys(mems).sort().forEach(n => {
                    let cats = Object.keys(mems[n].cats).map(c => `<div class="flex items-center py-0.5 text-[10px] h-6"><span class="${(CATEGORY_COLORS[c]||CATEGORY_COLORS.default).text} font-medium flex-1 text-left truncate">${CATEGORY_NAMES[c]}</span><div class="flex items-center gap-0.5 flex-none"><span class="${(CATEGORY_COLORS[c]||CATEGORY_COLORS.default).text} font-bold">TW$</span><span class="${(CATEGORY_COLORS[c]||CATEGORY_COLORS.default).text} font-bold text-right min-w-[35px]">${mems[n].cats[c].toFixed(0)}</span></div></div>`).join('');
                    let totalRow = `<div class="flex items-center py-0.5 text-[10px] h-6 border-t mt-1 pt-1 font-bold text-gray-700"><span class="flex-1 text-left">ç¸½è¨ˆ</span><div class="flex items-center gap-0.5 flex-none"><span>TW$</span><span class="text-right min-w-[35px]">${mems[n].total.toFixed(0)}</span></div></div>`;
                    document.getElementById('exp-mem-list').innerHTML += `<div><div class="font-bold text-gray-600 mb-1 border-b pb-0.5">${n}</div>${cats}${totalRow}</div>`;
                });
                
                let debtors = [], creditors = [];
                for(let n in balances) { 
                    if(balances[n] < -0.99) debtors.push({n, a: Math.abs(balances[n])}); 
                    else if(balances[n] > 0.99) creditors.push({n, a: balances[n]}); 
                }

                const setCont = document.getElementById('settlement');
                if(!debtors.length) setCont.innerHTML = '<div class="text-[10px] text-gray-400 text-center">å·²çµæ¸…</div>';
                else {
                    let i=0, j=0;
                    while(i < debtors.length && j < creditors.length){
                        let amt = Math.min(debtors[i].a, creditors[j].a);
                        setCont.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-2.5 rounded-xl text-[11px] w-full"><div class="flex justify-around items-center flex-grow text-gray-600 mr-4"><span class="font-bold">${debtors[i].n}</span><span class="text-gray-400">â†’</span><span class="font-bold">${creditors[j].n}</span></div><div class="font-bold text-[#7E92A1] flex-none text-right">TW$${amt.toFixed(0)}</div></div>`;
                        debtors[i].a -= amt; creditors[j].a -= amt;
                        if(debtors[i].a < 1) i++; if(creditors[j].a < 1) j++;
                    }
                }
                modal.style.display = 'flex';
            }

            async function deleteSchedule(id) { if(confirm('ç¢ºå®šåˆªé™¤?')) { await deleteDoc(doc(db, `artifacts/${appId}/public/data/Trips/${currentTripId}/Schedules`, id)); loadSchedules(currentTripId, currentDayId); document.getElementById('add-schedule-modal').style.display='none'; } }

            function initApp() {
                document.addEventListener('DOMContentLoaded', async () => {
                    const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); 
                    try {
                        const userCred = await signInAnonymously(auth); currentUser = userCred.user;
                        loadTripList();
                    } catch (e) {}
                    
                    document.getElementById('trip-select').onchange = (e) => changeTrip(e.target.value);
                    document.getElementById('center-add-btn').onclick = () => {
                        if(!currentTripId) return alert('è«‹å…ˆå»ºç«‹è¨ˆç•«');
                        const trip = tripData[currentTripId];
                        const dayDate = getDateFromDayId(trip, currentDayId);
                        openEditScheduleModal({ 
                            Location: '', 
                            Date: dayDate ? dayDate.toISOString().split('T')[0] : new Date().toISOString().split('T')[0], 
                            Time: '12:00', 
                            Type: 'location', 
                            members: trip.members || [] 
                        });
                    };
                    document.getElementById('settings-btn').onclick = openSettingsModal;
                    document.getElementById('btn-lists').onclick = loadLists;
                    document.getElementById('lists-modal-close-btn').onclick = () => document.getElementById('lists-modal').style.display='none';
                    document.getElementById('split-expense-btn').onclick = loadExpenseSummary;
                    document.getElementById('bar-calc-amount').oninput = calculateCurrency;
                    document.getElementById('bar-calc-currency').onchange = calculateCurrency;
                    document.getElementById('image-zoom-modal').onclick = () => document.getElementById('image-zoom-modal').style.display='none';
                });
            }
            return { initApp };
        })();
        window.App.initApp();
    </script>
</body>
</html>
